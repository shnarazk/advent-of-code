#!/usr/bin/env cbqn
DecodeSetToken â† {
  âŸ¨'v',lâŸ© F pn : âŸ¨â€¢BQN 0âŠ‘l,â€¢BQN 4âŠ‘lâŸ© SetToken pn;
        i F x  : x
}
SetToken â† {âŸ¨val,idxâŸ© F pn: { Â¯âˆ=ğ•© ? valË™âŒ¾(1âŠ¸âŠ‘idxâŠ¸âŠ‘)pn ; (1âˆ¾ğ•©(âŒŠâ‹ˆâŒˆ)val)âŒ¾(idxâŠ¸âŠ‘)pn }1âŠ‘idxâŠ‘pn}
Unpropagated â† (1=âŠ‘)âŠ‘Ëœ # âˆ§ (1âŠ‘record â‰  Â¯âˆ) âˆ§ (2âŠ‘record â‰  Â¯âˆ)

# example â† âŸ¨
#     "value 5 goes to bot 2"
#     "bot 2 gives low to bot 1 and high to bot 0"
#     "value 3 goes to bot 1"
#     "bot 1 gives low to output 1 and high to bot 0"
#     "bot 0 gives low to output 2 and high to output 0"
#     "value 2 goes to bot 2"
#     âŸ©
# â€¢Show â‰âŸœ(DecodeÂ¨) example

Solve â‡ {envâ€¿part S data :
  âŸ¨StartsWith,TokenizeâŸ© â† â€¢Import "/util.bqn"âˆ¾Ëœ"." env.VarâŒ¾â‹ˆ "BQN_LIB"
  Decode â† {"value"â‰¡âŠ‘ğ•© ? 'v'â‹ˆ1â†“ğ•© ; "bot"â‰¡âŠ‘ğ•© ? 'b'â‹ˆ1â†“ğ•© ; !0}Tokenize
  Link â† {
    âŸ¨'b',lâŸ© F n :
      minâ€¿max â† âŸ¨â€¢BQN 5âŠ‘l,â€¢BQN 10âŠ‘lâŸ©
      {(4âŠ‘l) StartsWith "out" ? min â†© Â¯1Ã—1+min ; @}
      {(9âŠ‘l) StartsWith "out" ? max â†© Â¯1Ã—1+max ; @}
      minâ€¿maxâŒ¾((â€¢BQN âŠ‘l)âŠ¸âŠ‘)n ;
    i F x       : x
  }
  insts â† âŒ½DecodeÂ¨data
  network â† (Â¯âˆâ€¿Â¯âˆË™Â¨â†•220)LinkÂ´insts
  petri â† (0â€¿Â¯âˆâ€¿Â¯âˆË™Â¨â†•220)DecodeSetTokenÂ´insts
  {1=part ?
     Propagate â† {F pn :
       len â† â‰ pn
       target â† âŠ‘ (<1)âŠ’ËœpnâŠ¸UnpropagatedÂ¨â†•len
       {
         target<len ?
           âŸ¨lo,hiâŸ© â† targetâŠ‘network
           âŸ¨mi,maâŸ© â† 1â†“targetâŠ‘pn
           pn â†© 0âŒ¾(âŠ‘targetâŠ¸âŠ‘)pn
           {lo<0 ? @ ; pn â†© âŸ¨mi,loâŸ© SetToken pn}
           {hi<0 ? @ ; pn â†© âŸ¨ma,hiâŸ© SetToken pn}
           F pn
         ;
           pn
       }
     }
     âŠ‘âŠ‘{17â€¿61â‰¡1â€¿2âŠ¸âŠ}Â¨âŠ¸/{âŸ¨1+âŠ‘ğ•¨,1âŠ‘ğ•©,2âŠ‘ğ•©âŸ©}`Propagate petri ;
   2=part ?
    total â† 1
    Propagate2 â† {F pn :
      len â† â‰ pn
      target â† âŠ‘(<1)âŠ’ËœpnâŠ¸UnpropagatedÂ¨â†•len
      {
        target<len ?
          âŸ¨lo,hiâŸ© â† targetâŠ‘network
          âŸ¨mi,maâŸ© â† 1â†“targetâŠ‘pn
          pn â†© 0âŒ¾(âŠ‘targetâŠ¸âŠ‘)pn
          {0â‰¤lo ? pn â†© âŸ¨mi,loâŸ© SetToken pn ; Â¯3â‰¤lo ? totalÃ— â†© mi ; @}
          {0â‰¤hi ? pn â†© âŸ¨ma,hiâŸ© SetToken pn ; Â¯3â‰¤hi ? totalÃ— â†© ma ; @}
          F pn
        ;
          pn
      }
    }
    Propagate2(0â€¿Â¯âˆâ€¿Â¯âˆË™Â¨â†•220)DecodeSetTokenÂ´insts
    total
  }
}

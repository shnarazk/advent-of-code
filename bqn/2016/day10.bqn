#!/usr/bin/env cbqn
âŸ¨Min, Max, StartsWith, Switch, TokenizeâŸ© â† â€¢Import "../lib.bqn"
Decode â† {
    l â† Tokenize ğ•©
    Switch âŸ¨âŠ‘l
        "value" â‹„  { ğ•¤â‹„ 'v'â€¿(1â†“l)}
        "bot"   â‹„  { ğ•¤â‹„ 'b'â€¿(1â†“l)}
    âŸ©
}
# Part 1: #####################################
Link â† {
    âŸ¨'b', lâŸ© F n: {
        âŸ¨min, maxâŸ© â† âŸ¨â€¢BQN 5âŠ‘l, â€¢BQN 10âŠ‘lâŸ©
        { (4âŠ‘l) StartsWith "out" ? min â†© Â¯1Ã—1+min;@ }
        { (9âŠ‘l) StartsWith "out" ? max â†© Â¯1Ã—1+max;@ }
        minâ€¿maxâŒ¾((â€¢BQN âŠ‘l)âŠ¸âŠ‘) n
    };
    i F x: x
}
DecodeSetToken â† {
    âŸ¨'v', lâŸ© F pn: âŸ¨â€¢BQN 0âŠ‘l, â€¢BQN 4âŠ‘lâŸ© SetToken pn;
    i F x: x
}
SetToken â† { âŸ¨val, idxâŸ© F pn:
    fst â† 1âŠ‘idxâŠ‘pn
    {
        fst = Â¯âˆ ?
            valË™âŒ¾(1âŠ¸âŠ‘idxâŠ¸âŠ‘) pn
        ;
            # â€¢Show "Ready "â€¿idx
            âŸ¨mi, maâŸ© â† âŸ¨fst Min val, fst Max valâŸ©
            (1â€¿miâ€¿ma)Ë™âŒ¾(idxâŠ¸âŠ‘) pn
    }
}
Unpropagated â† { pn F idx:
    record â† idxâŠ‘pn
    (0âŠ‘record = 1) # âˆ§ (1âŠ‘record â‰  Â¯âˆ) âˆ§ (2âŠ‘record â‰  Â¯âˆ)
}
Propagate â† { F pn:
    len â† â‰ pn
    target â† âŠ‘ (<1)âŠ’Ëœ(pnâŠ¸Unpropagated)Â¨ â†•len
    {
        (target < len) ?
            # â€¢Show "Fire "â€¿target
            âŸ¨lo, hiâŸ© â† targetâŠ‘network
            âŸ¨mi, maâŸ© â† 1â†“targetâŠ‘pn
            pn â†© 0Ë™âŒ¾(âŠ‘targetâŠ¸âŠ‘) pn
            { lo < 0 ? @; pn â†© âŸ¨mi, loâŸ© SetToken pn }
            { hi < 0 ? @; pn â†© âŸ¨ma, hiâŸ© SetToken pn }
            F pn
        ;
            pn
    }
}

example â† âŸ¨
    "value 5 goes to bot 2"
    "bot 2 gives low to bot 1 and high to bot 0"
    "value 3 goes to bot 1"
    "bot 1 gives low to output 1 and high to bot 0"
    "bot 0 gives low to output 2 and high to output 0"
    "value 2 goes to bot 2"
    âŸ©
â€¢Show â‰âŸœ(DecodeÂ¨) example
data â† â¥Š â€¢FLines "../../data/2016/input-day10.txt"
â€¢Show â‰âŸœ(DecodeÂ¨) 2â†‘ data
insts â† âŒ½ DecodeÂ¨ data
network â† (Â¯âˆâ€¿Â¯âˆË™Â¨ â†•220) LinkÂ´ insts
petri â† (0â€¿Â¯âˆâ€¿Â¯âˆË™Â¨ â†•220) DecodeSetTokenÂ´ insts
â€¢Show network
â€¢Show petri
petri â†© Propagate petri
â€¢Show petri
â€¢Show petri âŠ âŸ¨0â€¿17â€¿61âŸ©
# petri2 â† âŸ¨0, 0, 0âŸ© {âŸ¨1+âŠ‘ğ•¨, "1âŠ‘ğ•©", 2âŠ‘ğ•¨âŸ©}` petri
petri â†© {âŸ¨1+âŠ‘ğ•¨, 1âŠ‘ğ•©, 2âŠ‘ğ•©âŸ©}` petri
â€¢Show petri
# Part 2: #####################################
total â† 1
Propagate2 â† { F pn:
    len â† â‰ pn
    target â† âŠ‘ (<1)âŠ’Ëœ(pnâŠ¸Unpropagated)Â¨ â†•len
    {
        (target < len) ?
            # â€¢Show "Fire "â€¿target
            âŸ¨lo, hiâŸ© â† targetâŠ‘network
            âŸ¨mi, maâŸ© â† 1â†“targetâŠ‘pn
            pn â†© 0Ë™âŒ¾(âŠ‘targetâŠ¸âŠ‘) pn
            {
                0  â‰¤ lo ? pn â†© âŸ¨mi, loâŸ© SetToken pn;
                Â¯3 â‰¤ lo ? totalÃ—â†©mi;
                @
            }
            {
                0  â‰¤ hi ? pn â†© âŸ¨ma, hiâŸ© SetToken pn;
                Â¯3 â‰¤ hi ? totalÃ—â†©ma;
                @
            }
            F pn
        ;
            pn
    }
}
petri2 â† Propagate2 (0â€¿Â¯âˆâ€¿Â¯âˆË™Â¨ â†•220) DecodeSetTokenÂ´ insts
â€¢Show total

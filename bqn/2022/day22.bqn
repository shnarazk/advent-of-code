Solve â‡ {envâ€¿part ğ•Š data :
  util â† â€¢Import "/util.bqn"âˆ¾Ëœ"." env.VarâŒ¾â‹ˆ "BQN_LIB"
  width â† âŒˆÂ´â‰ Â¨Â¯1â†“data
  map â† >widthâŠ¸â†‘Â¨Â¯2â†“data
  unit_size â† mapâ‰ âŠ¸Ã·4
  map â†© Â¯1âŒ½â‰2 Â¯1âŒ½â‰1(2+â‰¢map)â†‘map
  Warp â† {loc ğ•Š vec :
    âŸ¨Â¯1, 0âŸ©â‰¡ğ•© ? (1âŠ‘ğ•¨)âˆ¾ËœÂ¯1âŠ‘1âŠ‘âŠ”' 'â‰ (1âŠ‘ğ•¨)âŠâ‰1 map ;
    âŸ¨ 1, 0âŸ©â‰¡ğ•© ? (1âŠ‘ğ•¨)âˆ¾Ëœ  âŠ‘1âŠ‘âŠ”' 'â‰ (1âŠ‘ğ•¨)âŠâ‰1 map ;
    âŸ¨ 0,Â¯1âŸ©â‰¡ğ•© ? ( âŠ‘ğ•¨)âˆ¾ Â¯1âŠ‘1âŠ‘âŠ”' 'â‰ ( âŠ‘ğ•¨)âŠâ‰2 map ;
    âŸ¨ 0, 1âŸ©â‰¡ğ•© ? ( âŠ‘ğ•¨)âˆ¾   âŠ‘1âŠ‘âŠ”' 'â‰ ( âŠ‘ğ•¨)âŠâ‰2 map ;
    !0
  }
  "# path" util.Debug (20âŒŠâ‰ )âŠ¸â†‘path â† âˆ¾âŸœ"â†’"Â¯1âŠ‘data
  route â† Â¯1âŠ¸(util.ParseIntâˆ˜â†“â‹ˆ{-Â¬âŠ‘"Lâ†’R"âŠ¸âŠğ•©}âˆ˜âŠ‘)Â¨((0âˆ¾Â·<Â´Â¨Â·â¥ŠÂ·<Ë˜2âŠ¸â†•)âŠ¸(-Ëœ)+`pathâˆŠ"LRâ†’")âŠ”path
  start â† 1âˆ¾âŠ‘"."âŠ’Ëœ1âŠmap
  Move â† {distâ€¿turn ğ•Š locâ€¿dir :
    vec â† dirâŠ‘âŸ¨Â¯1â€¿0,0â€¿1,1â€¿0,0â€¿Â¯1âŸ©
    {
      '.'â‰¡(n â† vec+loc)âŠ‘map ? loc â†© nâ‹„ -Â¬ğ•© ;
      '#'â‰¡(n â† vec+loc)âŠ‘map ? 0 ;
      newloc â† loc Warp vec
      count â† ğ•©
      {'.'â‰¡newlocâŠ‘map ? loc â†© newloc â‹„ -Â¬count ; '#'â‰¡newlocâŠ‘map ? 0 ; !0}
    }â€¢_while_(0âŠ¸<)dist
    âŸ¨loc, 4|4+dir+turnâŸ©
  }
  Move2 â† {distâ€¿turn ğ•Š locâ€¿dir :
    {
      '.'â‰¡(n â† loc+dirâŠ‘âŸ¨Â¯1â€¿0,0â€¿1,1â€¿0,0â€¿Â¯1âŸ©)âŠ‘map ? loc â†© n â‹„ -Â¬ğ•© ;
      '#'â‰¡(n â† loc+dirâŠ‘âŸ¨Â¯1â€¿0,0â€¿1,1â€¿0,0â€¿Â¯1âŸ©)âŠ‘map ? 0 ;
      e â† unit_size-1
      loc1â€¿dir1 â† {
        patch â† ğ•©âŒŠâˆ˜Ã·unit_size
        dyâ€¿dx â† unit_size|ğ•©
        {
          # vertical warp
          âŸ¨0,1âŸ©â€¿0 : âŸ¨âŸ¨dx,  0âŸ©+unit_sizeÃ—3â€¿0,1âŸ© ;
          âŸ¨0,2âŸ©â€¿0 : âŸ¨âŸ¨e,  dxâŸ©+unit_sizeÃ—3â€¿0,0âŸ© ;
          âŸ¨0,2âŸ©â€¿2 : âŸ¨âŸ¨dx,  eâŸ©+unit_sizeÃ—1â€¿1,3âŸ© ;
          âŸ¨2,0âŸ©â€¿0 : âŸ¨âŸ¨dx,  0âŸ©+unit_sizeÃ—1â€¿1,1âŸ© ;
          âŸ¨2,1âŸ©â€¿2 : âŸ¨âŸ¨dx,  eâŸ©+unit_sizeÃ—3â€¿0,3âŸ© ;
          âŸ¨3,0âŸ©â€¿2 : âŸ¨âŸ¨0,  dxâŸ©+unit_sizeÃ—0â€¿2,2âŸ© ;
          # horizontal warp
          âŸ¨0,1âŸ©â€¿3 : âŸ¨âŸ¨e-dy,0âŸ©+unit_sizeÃ—2â€¿0,1âŸ© ;
          âŸ¨0,2âŸ©â€¿1 : âŸ¨âŸ¨e-dy,eâŸ©+unit_sizeÃ—2â€¿1,3âŸ© ;
          âŸ¨1,1âŸ©â€¿3 : âŸ¨âŸ¨0,  dyâŸ©+unit_sizeÃ—2â€¿0,2âŸ© ;
          âŸ¨1,1âŸ©â€¿1 : âŸ¨âŸ¨e,  dyâŸ©+unit_sizeÃ—0â€¿2,0âŸ© ;
          âŸ¨2,0âŸ©â€¿3 : âŸ¨âŸ¨e-dy,0âŸ©+unit_sizeÃ—0â€¿1,1âŸ© ;
          âŸ¨2,1âŸ©â€¿1 : âŸ¨âŸ¨e-dy,eâŸ©+unit_sizeÃ—0â€¿2,3âŸ© ;
          âŸ¨3,0âŸ©â€¿3 : âŸ¨âŸ¨0,  dyâŸ©+unit_sizeÃ—0â€¿1,2âŸ© ;
          âŸ¨3,0âŸ©â€¿1 : âŸ¨âŸ¨e,  dyâŸ©+unit_sizeÃ—2â€¿1,0âŸ© ;
          !0
        }patchâ€¿dir
      }âŒ¾(-Â¬)loc    # under the zero-indexed space
      count â† ğ•©
      {'.'â‰¡loc1âŠ‘map ? locâ€¿dir â†© âŸ¨loc1,dir1-1âŸ© â‹„ -Â¬count ; '#'â‰¡loc1âŠ‘map ? 0 ; !0}
    }â€¢_while_(0âŠ¸<)dist
    âŸ¨loc, 4|4+dir+turnâŸ©
  }
  {
    f â† {1=part ? Move ; Move2}
    {(yâ€¿x)â€¿dir : (4|3+dir)+(4Ã—x)+1000Ã—y}startâ€¿1 FÂ´âŒ½route
  }
}

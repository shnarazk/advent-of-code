#!/usr/bin/env cbqn
âŸ¨DataFile,ParseInts,Swap,WhileâŸ© â† â€¢Import "../lib.bqn"
âŸ¨_to_heapâŸ© â† â€¢Import "../heap.bqn"
data â† âˆ§(Swap ParseIntsâˆ¾{((<1âŠ¸âŠ‘)âˆ¾9âŠ¸â†“)(','âŠ¸â‰ Â¨âŠ¸/)Â¨" "âŠ¸((âŠ¢-ËœÂ¬Ã—Â·+`Â»âŠ¸<)âˆ˜âˆŠËœâŠ”âŠ¢)ğ•©})Â¨ â€¢Flines "data/2022/input-day16.txt" DataFile â€¢args
nodes â† â·âŠ‘Â¨data
! 0=âŠ‘nodesâŠ<"AA" # Product â† +Ëâˆ˜Ã—â‰1â€¿âˆ
label_pairs â† âˆ§âˆ¾(âŠ(âˆ¾â—‹<)Â¨(2âŠ¸â†“))Â¨data
pairs â† {ğ•Š âŸ¨a,bâŸ©: âŸ¨âŠ‘nodesâŠ’<a,âŠ‘nodesâŠ’<bâŸ©}Â¨label_pairs
# â€¢Show idist â† {ğ•¨â‰¡ğ•© ? 0; âŠ‘pairsâˆŠËœâ‹ˆâŸ¨ğ•¨,ğ•©âŸ© ? 1; âˆ}âŒœËœâ†•â‰ nodes 
# ! idistâ‰¡â‰idist
â€¢Show dist â† (âŒŠËâˆ˜+â‰1â€¿âˆ)âŸ(â‰ nodes)Ëœ {ğ•¨â‰¡ğ•© ? 0; âŠ‘pairsâˆŠËœâ‹ˆâŸ¨ğ•¨,ğ•©âŸ© ? 1; âˆ}âŒœËœâ†•â‰ nodes
! distâ‰¡â‰dist
To_visit â† (>â—‹âŠ‘)_to_heap
to_visit.Push initial_state â† <âŸ¨0, 0, 0, (0âŠ¸=)Â¨â†•â‰ nodesâŸ©
# visited is a map from âŸ¨time, location, mapâŸ© to flow
visited â† âˆ˜â€¿2â¥ŠâŸ¨âŸ¨0, 0, 3âŠ‘âŠ‘initial_stateâŸ©, 0âŸ©
Expand â† {limit F âŸ¨flow, time, pos, statesâŸ©:
  {limitâ‰¤time ?@;
    {F âŸ¨next_pos,costâŸ©:
      new_time â† 1+time+cost
      {(0=cost)âˆ¨(next_posâŠ‘states)âˆ¨(limitâ‰¤new_time)âˆ¨(0=1âŠ‘next_posâŠ‘data) ?@;
        new_flow â† flow + (limit-new_time)Ã—1âŠ‘next_posâŠ‘data
        new_states â† 1Ë™âŒ¾(next_posâŠ¸âŠ‘)states
        key â† âŸ¨new_time,next_pos,new_statesâŸ©
        key_index â† âŠ‘(âŠ‘Ë˜visited)âŠâŸ¨keyâŸ©
        {key_index<â‰ visited ?@; visited (âˆ¾âŸœ(âˆ˜â€¿2â¥ŠâŸ¨key,0âŸ©))â†©} # ensure the key exists
        ! keyâ‰¡key_indexâ€¿0âŠ‘visited
        ! Â¯âˆ<key_indexâ€¿1âŠ‘visited
        so_far â† âŒˆÂ´(({(new_timeâ‰¥âŠ‘ğ•©)âˆ§(key â‰¡â—‹(1â†“âŠ‘) ğ•©)}âˆ˜âŠ‘)Â¨)âŠ¸/âŸœ((1âŠ¸âŠ‘)Â¨)â¥Š<Ë˜visited
        {new_flow â‰¤ so_far ?@;
          visited â†© new_flowË™âŒ¾(key_indexâ€¿1âŠ¸âŠ‘) visited
          to_visit.Push<âŸ¨new_flow,new_time,next_pos,new_statesâŸ©
        }
      }
    }Â¨ ((â†•â‰ )â‹ˆÂ¨âŠ¢) posâŠdist
  }
}
Serch â† {F limit:
  cands â† âŸ¨0âŸ©
  While {ğ•¤â‹„ Â¬to_visit.Empty @}â€¿{ğ•¤â‹„
    state â† to_visit.Pop @â‹„
    {âŠ‘stateâ‰¥âŒˆÂ´cands ?
      â€¢Show 2â†‘state
      â€¢Show (3âŠ‘state)/nodes
      ; @}
    ! limit>1âŠ‘state
    cands â†© â·(âŠ‘state)âˆ¾candsâ‹„
    limit Expand state}
  cands
}
â€¢Show âŠ‘âˆ¨ Serch 30

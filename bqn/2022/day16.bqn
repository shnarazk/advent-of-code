#!/usr/bin/env cbqn
âŸ¨DataFile,ParseInts,Swap,WhileâŸ© â† â€¢Import "../lib.bqn"
âŸ¨_to_heapâŸ© â† â€¢Import "../heap.bqn"
data â† (Swap ParseIntsâˆ¾{((<1âŠ¸âŠ‘)âˆ¾9âŠ¸â†“)(','âŠ¸â‰ Â¨âŠ¸/)Â¨" "âŠ¸((âŠ¢-ËœÂ¬Ã—Â·+`Â»âŠ¸<)âˆ˜âˆŠËœâŠ”âŠ¢)ğ•©})Â¨ â€¢Flines "data/2022/input-day16.txt" DataFile âŸ¨âŸ© # â€¢args
nodes â† âˆ§â·âŠ‘Â¨data
! 0=âŠ‘nodesâŠ<"AA" # Product â† +Ëâˆ˜Ã—â‰1â€¿âˆ
label_pairs â† âˆ§âˆ¾(âŠ(âˆ¾â—‹<)Â¨(2âŠ¸â†“))Â¨data
pairs â† {ğ•Š âŸ¨a,bâŸ©: âŸ¨âŠ‘nodesâŠ’<a,âŠ‘nodesâŠ’<bâŸ©}Â¨label_pairs
dist â† (âŒŠËâˆ˜+â‰1â€¿âˆ)âŸ(â‰ nodes)Ëœ {ğ•¨â‰¡ğ•© ? 0; âŠ‘pairsâˆŠËœâ‹ˆâŸ¨ğ•¨,ğ•©âŸ© ? 1; âˆ}âŒœËœâ†•â‰ nodes
To_visit â† (<â—‹âŠ‘)_to_heap
to_visit.Push initial_state â† <âŸ¨0, 0, 0, (0âŠ¸=)Â¨â†•â‰ nodesâŸ©
# initialize   : d â† âˆ˜â€¿2â¥Šâˆ¾{âŸ¨<âŸ¨ğ•©,33âŸ©,0âŸ©}Â¨â†•3
# add an itme  : d ((âˆ˜â€¿2â¥ŠâŸ¨<âŸ¨88,55âŸ©,1âŸ©)âŠ¸âˆ¾)â†©
# update value : d â†© 3Ë™âŒ¾(2â€¿1âŠ¸âŠ‘) d
# contain key  : (âŠ‘(âŠ‘Ë˜d)âŠâŸ¨âŸ¨1,Â¯1âŸ©âŸ©)<â‰ d
# access by key: (âŠ‘(âŠ‘Ë˜d)âŠâŸ¨âŸ¨1,33âŸ©âŸ©)â€¿1âŠ‘d
# visited is a map from âŸ¨current_location, current_time, visited_mapâŸ© to reward
visited â† âˆ˜â€¿2â¥ŠâŸ¨âŸ¨0, 0, 3âŠ‘âŠ‘initial_stateâŸ©, 0âŸ©
Expand â† {limit F âŸ¨time, flow, pos, statesâŸ©:
  {F âŸ¨next_pos,costâŸ©:
    {(next_pos=pos)âˆ¨(next_posâŠ‘states)âˆ¨(limit<time+cost) ?@;
      new_time â† 1+time+cost
      new_flow â† flow + (limit-new_time)Ã—1âŠ‘next_posâŠ‘data
      new_states â† 1Ë™âŒ¾(next_posâŠ¸âŠ‘)states
      new â† <âŸ¨new_time,new_flow,next_pos,new_statesâŸ©
      # visited requires a key: âŸ¨current_location, current_time, visited_mapâŸ© 
      key_index â† âŠ‘(âŠ‘Ë˜visited)âŠâŸ¨key â† âŸ¨next_pos, new_time, new_statesâŸ©âŸ©
      {key_index<â‰ visited ?@; visited (âˆ¾âŸœ(âˆ˜â€¿2â¥ŠâŸ¨key,0âŸ©))â†©} # ensure the key exists
      # so_far â† key_indexâ€¿1âŠ‘visited
      # â€¢Out "visited"
      # â€¢Show visited
      # â€¢Show â‰¢visited
      # â€¢Out "â¥Š<Ë˜visited"
      # â€¢Show â¥Š<Ë˜visited
      # â€¢Show â‰¢âŠ‘â¥Š<Ë˜visited
      # â€¢Show "xx"â€¿(âŠ‘âŠ‘â¥Š<Ë˜visited)
      # â€¢Out "keys"
      # â€¢Show (âŠ‘)Â¨ â¥Š<Ë˜visited
      # â€¢Out "keys2"
      # â€¢Show (2âŠ¸âŠ‘âŠ‘)Â¨ â¥Š<Ë˜visited
      so_far â† âŒˆÂ´ (({(key =â—‹âŠ‘ ğ•©)âˆ§(new_timeâ‰¥1âŠ‘ğ•©)âˆ§(key â‰¡â—‹(2âŠ¸âŠ‘) ğ•©)}âˆ˜âŠ‘)Â¨)âŠ¸/âŸœ((1âŠ¸âŠ‘)Â¨) â¥Š<Ë˜visited
      # so_far â† âŒˆÂ´ (({â€¢Show âŸ¨"key-x", ğ•©âŸ©â‹„ (key =â—‹âŠ‘ ğ•©)âˆ§(new_timeâ‰¥1âŠ‘ğ•©)âˆ§(key â‰¡â—‹(2âŠ¸âŠ‘) ğ•©)}âˆ˜âŠ‘)Â¨)âŠ¸/âŸœ((1âŠ¸âŠ‘)Â¨) â¥Š<Ë˜visited
      # â€¢Show "so_far"â€¿so_far
      # so_far â† âŒˆÂ´{(âŠ‘ğ•©)â€¿1âŠ‘visited}Â¨âˆ¾{F x:â€¢Show (âŸ¨âŠ‘key,x,2âŠ‘keyâŸ©âŠ¸â‰¡âŸœ(âŠ‘âŠ‘))Â¨â¥Š<Ë˜visitedâ‹„ âˆ¾âˆ˜((âŸ¨âŠ‘key,x,2âŠ‘keyâŸ©âŠ¸â‰¡âŸœ(âŠ‘âŠ‘))Â¨/((â†•â‰ )(â‹ˆÂ¨)âŠ¢)) â¥Š<Ë˜visited}Â¨â†•new_time
      {new_flow â‰¤ so_far ?@;
        visited â†© new_flowË™âŒ¾(key_indexâ€¿1âŠ¸âŠ‘) visited
        to_visit.Push new
      }
    }
  }Â¨ ((â†•â‰ )â‹ˆÂ¨âŠ¢) posâŠdist
}
Serch â† {F limit: 
  cands â† âŸ¨0âŸ©
  While {ğ•¤â‹„ Â¬to_visit.Empty @}â€¿{ğ•¤â‹„ state â† to_visit.Pop @â‹„ cands â†© â·(1âŠ‘state)âˆ¾candsâ‹„ limit Expand state}
  cands
}
â€¢Show âŠ‘âˆ¨ Serch 30

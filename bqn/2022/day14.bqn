lib â† â€¢Import "../lib.bqn"

Solve â‡ { part ğ•Š data:
  "region" lib.Debug xmaxâ€¿ymax â† â‹ˆâ—‹(2âŠ¸+)Â´âŒˆË>âˆ¾segments â† <Ë˜Â¨âˆ˜â€¿2âŠ¸â¥ŠÂ¨âŸ¨âŸ©âŠ¸â‰¢Â¨âŠ¸/ lib.ParseIntsÂ¨ data
  {
    1=part ?
      map â† ymaxâ€¿xmaxâ¥Š 0Ë™â†•xmaxÃ—ymax
      InjectBlocks â† { ğ•Š begâ€¿end:
        dxâ€¿dy â† end-beg
        seq â† {
          0<dy ? â‹ˆâŸœ(0âŠ‘beg)Â¨(1âŠ‘beg)+â†•1+|dy;
          0>dy ? â‹ˆâŸœ(0âŠ‘end)Â¨(1âŠ‘end)+â†•1+|dy;
          0<dx ? (1âŠ‘beg)âŠ¸â‹ˆÂ¨(0âŠ‘beg)+â†•1+|dx;
          0>dx ? (1âŠ‘end)âŠ¸â‹ˆÂ¨(0âŠ‘end)+â†•1+|dx
        }
        map (1Ë™Â¨seq)âŒ¾(seqâŠ¸âŠ‘) â†©
        âŸ¨âŸ©
      }Â¨<Ë˜âˆ˜(2âŠ¸â†•)
      InjectBlocksÂ¨ segments
      lib.Debug "starting"
      sandsâ€¿trace â† 0â€¿âŸ¨0â€¿500âŸ©
      DropSand1 â† { ğ•Š tr:
        yâ€¿x â† start â† Â¯1âŠ‘tr
        falling â† 1
        lib.While { ğ•¤, falling } â€¿ { ğ•¤,
          new_y â† 1+y
          {
            ymax=new_y ?
              map 1Ë™âŒ¾(yâ€¿xâŠ¸âŠ‘) â†©
              tr â†© âŸ¨âŸ©
              falling â†© 0
              ;
            (new_yâ€¿x (Â¬âŠ‘) map) ?
              y â†© new_y
              tr âˆ¾âŸœâŸ¨yâ€¿xâŸ© â†©
              ;
            (new_yâ€¿(Â¯1+x) (Â¬âŠ‘) map) ?
              yâ€¿x â†© new_yâ€¿(Â¯1+x)
              tr âˆ¾âŸœâŸ¨yâ€¿xâŸ© â†©
              ;
            (new_yâ€¿( 1+x) (Â¬âŠ‘) map) ?
              yâ€¿x â†© new_yâ€¿( 1+x)
              tr âˆ¾âŸœâŸ¨yâ€¿xâŸ© â†©
            ;
              map 1Ë™âŒ¾(yâ€¿xâŠ¸âŠ‘) â†©,
              tr Â¯1âŠ¸â†“ â†©
              falling â†© 0
          }
        }
        tr
      }
      While â† {ğ•¨{ğ•Šâˆ˜ğ”¾âŸğ”½ğ•©}ğ•©@}Â´
      # While â† {ğ•©{ğ”½âŸğ”¾âˆ˜ğ”½_ğ•£_ğ”¾âˆ˜ğ”½âŸğ”¾ğ•©}ğ•¨@}Â´
      # While â† {ğ•©{ğ”½âŸğ”¾âˆ˜ğ”½_ğ•£_ğ”¾âˆ˜ğ”½âŸğ”¾ğ•©}ğ•¨@}Â´
      # While â† {ğ•©{ğ”½_ğ•£_ğ”¾âˆ˜ğ”½âŸğ”¾ğ•©}ğ•¨@}Â´
      While { ğ•¤, trace DropSand1 â†©, âŸ¨âŸ©â‰¢trace }â€¿{ ğ•¤, sands 1âŠ¸+ â†© }
      # lib.While { ğ•¤, 0<â‰ trace }â€¿{ ğ•¤, trace DropSand1 â†©, sands 1âŠ¸+ â†© }
      sands
    ;
      xmax ymaxâŠ¸+ â†©
      map â† ymaxâ€¿xmaxâ¥Š 0Ë™â†•xmaxÃ—ymax
      InjectBlocks â† { ğ•Š begâ€¿end:
        dxâ€¿dy â† end-beg
        seq â† {
          0<dy ? â‹ˆâŸœ(0âŠ‘beg)Â¨(1âŠ‘beg)+â†•1+|dy;
          0>dy ? â‹ˆâŸœ(0âŠ‘end)Â¨(1âŠ‘end)+â†•1+|dy;
          0<dx ? (1âŠ‘beg)âŠ¸â‹ˆÂ¨(0âŠ‘beg)+â†•1+|dx;
          0>dx ? (1âŠ‘end)âŠ¸â‹ˆÂ¨(0âŠ‘end)+â†•1+|dx
        }
        map (1Ë™Â¨seq)âŒ¾(seqâŠ¸âŠ‘) â†©
        âŸ¨âŸ©
      }Â¨<Ë˜âˆ˜(2âŠ¸â†•)
      InjectBlocksÂ¨ segments
      lib.Debug "starting"
      DropSand2 â† { y ğ•Š x:
        0=yâ€¿xâŠ‘map ?
          map 2Ë™âŒ¾(yâ€¿xâŠ¸âŠ‘) â†©
          # { yy â† y, lib.While { ğ•¤, ymax>yy ? 0=yyâ€¿xâŠ‘map; 0 }â€¿{ ğ•¤, map 2Ë™âŒ¾(yyâ€¿xâŠ¸âŠ‘) â†©, yy 1âŠ¸+ â†© } }
          { ymax>yy â† 1+y ? yy DropSand2Â¨ x+âŸ¨Â¯1,0,1âŸ© ; @ }
        ;
          @
      }
      0 DropSand2 500
      +Â´2=â¥Šmap
  }
}

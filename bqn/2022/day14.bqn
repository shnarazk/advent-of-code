Solve â‡ {envâ€¿part ğ•Š data :
  util â† â€¢Import "/util.bqn"âˆ¾Ëœ"." env.VarâŒ¾â‹ˆ "BQN_LIB"
  "region" util.Debug ymaxâ€¿xmax â† â‹ˆâ—‹(2âŠ¸+)Â´âŒˆË>âˆ¾segments â† âŒ½Â¨Â¨<Ë˜Â¨âˆ˜â€¿2âŠ¸â¥ŠÂ¨âŸ¨âŸ©âŠ¸â‰¢Â¨âŠ¸/util.ParseIntsÂ¨data
  {2=part ? xmax ymaxâŠ¸+ â†© ; @}
  map â† ymaxâ€¿xmaxâ¥Š0Ë™â†•xmaxÃ—ymax
  InjectBlocks â† {begâ€¿end :
    dyâ€¿dx â† end-beg
    seq â† {
      0<dy ? â‹ˆâŸœ(1âŠ‘beg)Â¨(0âŠ‘beg)+â†•1+|dy ;
      0>dy ? â‹ˆâŸœ(1âŠ‘end)Â¨(0âŠ‘end)+â†•1+|dy ;
      0<dx ? (0âŠ‘beg)âŠ¸â‹ˆÂ¨(1âŠ‘beg)+â†•1+|dx ;
      0>dx ? (0âŠ‘end)âŠ¸â‹ˆÂ¨(1âŠ‘end)+â†•1+|dx
    }
    map 1Â¨âŒ¾(seqâŠ¸âŠ‘) â†©
  }Â¨<Ë˜âˆ˜(2âŠ¸â†•)
  InjectBlocksÂ¨segments
  {
    1=part ?
      DropSand â† {
        1âŠ‘{fallingâ€¿tr :
          loc â† Â¯1âŠ‘tr
          {
            ymax=1+âŠ‘loc                ? map 1Ë™âŒ¾(locâŠ¸âŠ‘) â†© â‹„ 0â€¿âŸ¨âŸ© ;
            (newloc â† loc+1â€¿ 0)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
            (newloc â† loc+1â€¿Â¯1)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
            (newloc â† loc+1â€¿ 1)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
                                         map 1Ë™âŒ¾(locâŠ¸âŠ‘) â†© â‹„ âŸ¨0,Â¯1â†“trâŸ©
          }
        }â€¢_while_âŠ‘1â€¿ğ•©
      }
      Â¯1+âŠ‘{sandsâ€¿trace : âŸ¨1+sands,DropSand traceâŸ©}â€¢_while_{âŸ¨âŸ©âŠ¸â‰¢1âŠ‘ğ•©}0â€¿âŸ¨0â€¿500âŸ©
    ;
      floor â† 2+âŒˆÂ´1âŠ¸âŠ‘Â¨âˆ¾segments
      map â†© floorâ€¿(2Ã—xmax)â†‘map       # Expand region
      front â† 500=â†•1âŠ‘â‰¢map
      âŠ‘1â€¿front{ğ•¨ ğ•Š sandsâ€¿line : (sands++Â´)âŠ¸â‹ˆğ•¨Â¬âŠ¸âˆ§âŒˆË[Â«line,line,Â»line]}Â´âŒ½1â†“â¥Š<Ë˜map
  }
}

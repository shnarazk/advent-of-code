Solve â‡ {envâ€¿part ğ•Š data :
  lib â† â€¢Import "/util.bqn"âˆ¾Ëœ"." env.VarâŒ¾â‹ˆ "BQN_LIB"
  "region" lib.Debug xmaxâ€¿ymax â† â‹ˆâ—‹(2âŠ¸+)Â´âŒˆË>âˆ¾segments â† <Ë˜Â¨âˆ˜â€¿2âŠ¸â¥ŠÂ¨âŸ¨âŸ©âŠ¸â‰¢Â¨âŠ¸/lib.ParseIntsÂ¨data
  {2=part ? xmax ymaxâŠ¸+ â†© ; @}
  map â† ymaxâ€¿xmaxâ¥Š0Ë™â†•xmaxÃ—ymax
  InjectBlocks â† {begâ€¿end :
    dxâ€¿dy â† end-beg
    seq â† {
      0<dy ? â‹ˆâŸœ(0âŠ‘beg)Â¨(1âŠ‘beg)+â†•1+|dy ;
      0>dy ? â‹ˆâŸœ(0âŠ‘end)Â¨(1âŠ‘end)+â†•1+|dy ;
      0<dx ? (1âŠ‘beg)âŠ¸â‹ˆÂ¨(0âŠ‘beg)+â†•1+|dx ;
      0>dx ? (1âŠ‘end)âŠ¸â‹ˆÂ¨(0âŠ‘end)+â†•1+|dx
    }
    map 1Â¨âŒ¾(seqâŠ¸âŠ‘) â†©
  }Â¨<Ë˜âˆ˜(2âŠ¸â†•)
  InjectBlocksÂ¨segments
  {
    1=part ?
      DropSand â† {
        1âŠ‘{fallingâ€¿tr :
          loc â† Â¯1âŠ‘tr
          {
            ymax=1+âŠ‘loc                ? map 1Ë™âŒ¾(locâŠ¸âŠ‘) â†© â‹„ 0â€¿âŸ¨âŸ© ;
            (newloc â† loc+1â€¿ 0)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
            (newloc â† loc+1â€¿Â¯1)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
            (newloc â† loc+1â€¿ 1)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
                                         map 1Ë™âŒ¾(locâŠ¸âŠ‘) â†© â‹„ âŸ¨0,Â¯1â†“trâŸ©
          }
        }â€¢_while_âŠ‘1â€¿ğ•©
      }
      Â¯1+âŠ‘{sandsâ€¿trace : âŸ¨1+sands,DropSand traceâŸ©}â€¢_while_{âŸ¨âŸ©âŠ¸â‰¢1âŠ‘ğ•©}0â€¿âŸ¨0â€¿500âŸ©
    ;
      0{y Drop x : 0=yâ€¿xâŠ‘map ? map 2Ë™âŒ¾(yâ€¿xâŠ¸âŠ‘) â†© â‹„ {ymax>yy â† 1+y ? yy DropÂ¨ x+âŸ¨Â¯1,0,1âŸ© ; @} ; @}500
      +Â´2=â¥Šmap
  }
}

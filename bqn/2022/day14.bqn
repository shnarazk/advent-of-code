lib â† â€¢Import "../lib.bqn"

InjectBlock â† { begâ€¿end ğ•Š m:
  dxâ€¿dy â† end-beg
  seq â† {
    0<dy ? â‹ˆâŸœ(0âŠ‘beg)Â¨(1âŠ‘beg)+â†•1+|dy;
    0>dy ? â‹ˆâŸœ(0âŠ‘end)Â¨(1âŠ‘end)+â†•1+|dy;
    0<dx ? (1âŠ‘beg)âŠ¸â‹ˆÂ¨(0âŠ‘beg)+â†•1+|dx;
    0>dx ? (1âŠ‘end)âŠ¸â‹ˆÂ¨(0âŠ‘end)+â†•1+|dx
  }
  (1Ë™Â¨seq)âŒ¾(seqâŠ¸âŠ‘) m
}Â´âŸœ(â¥Šâ‹ˆË˜âˆ˜(2âŠ¸â†•))Ëœ

Solve â‡ { part ğ•Š data:
  seg â† lib.ParseIntsÂ¨ data
  "geometry" lib.Debug xmaxâ€¿ymax â† (2âŠ¸+âŒˆÂ´)Â¨(Â¬â‹ˆâŠ¢)â—‹(2âŠ¸|Â¨â†•âˆ˜â‰ )âŠ¸{(â‹ˆâ—‹(/âŸœğ•©))Â´ ğ•¨} âˆ¾seg
  segments â† {(Â¬â‹ˆâŠ¢)â—‹(2âŠ¸|Â¨â†•âˆ˜â‰ )âŠ¸{(â‹ˆÂ¨â—‹(/âŸœğ•©))Â´ ğ•¨} ğ•©}Â¨ seg
  {
    1=part ?
      map â† segments InjectBlockÂ´Ëœ ymaxâ€¿xmaxâ¥Š 0Ë™â†•xmaxÃ—ymax
      lib.Debug "starting"
      sandsâ€¿trace â† 0â€¿âŸ¨0â€¿500âŸ©
      DropSand1 â† { ğ•Š trace:
        yâ€¿x â† start â† Â¯1âŠ‘trace
        falling â† 1
        lib.While { ğ•¤, falling } â€¿ { ğ•¤,
          new_y â† 1+y
          {
            ymax=new_y ?
              map 1Ë™âŒ¾(yâ€¿xâŠ¸âŠ‘) â†©
              trace â†© âŸ¨âŸ©
              falling â†© 0
              ;
            (new_yâ€¿x (Â¬âŠ‘) map) ?
              y â†© new_y
              trace âˆ¾âŸœâŸ¨yâ€¿xâŸ© â†©
              ;
            (new_yâ€¿(Â¯1+x) (Â¬âŠ‘) map) ?
              yâ€¿x â†© new_yâ€¿(Â¯1+x)
              trace âˆ¾âŸœâŸ¨yâ€¿xâŸ© â†©
              ;
            (new_yâ€¿( 1+x) (Â¬âŠ‘) map) ?
              yâ€¿x â†© new_yâ€¿( 1+x)
              trace âˆ¾âŸœâŸ¨yâ€¿xâŸ© â†©
            ;
              map 1Ë™âŒ¾(yâ€¿xâŠ¸âŠ‘) â†©,
              trace Â¯1âŠ¸â†“ â†©
              falling â†© 0
          }
        }
        trace
      }
      lib.While { ğ•¤, 0<â‰ trace }â€¿{ ğ•¤, trace DropSand1 â†©, sands 1âŠ¸+ â†© }
      Â¯1+sands
    ;
      xmax ymaxâŠ¸+ â†©
      map â† segments InjectBlockÂ´Ëœ ymaxâ€¿xmaxâ¥Š 0Ë™â†•xmaxÃ—ymax
      lib.Debug "starting"
      DropSand2 â† { y ğ•Š x:
        0=yâ€¿xâŠ‘map ?
          map 2Ë™âŒ¾(yâ€¿xâŠ¸âŠ‘) â†©
          { yy â† y, lib.While { ğ•¤, ymax>yy ? 0=yyâ€¿xâŠ‘map; 0 }â€¿{ ğ•¤, map 2Ë™âŒ¾(yyâ€¿xâŠ¸âŠ‘) â†©, yy 1âŠ¸+ â†© } }
          { ymax>yy â† 1+y ? yy ğ•ŠÂ¨ x+âŸ¨Â¯1,0,1âŸ© ; @ }
        ;
          @
      }
      0 DropSand2 500
      +Â´2=â¥Šmap
  }
}

Solve â‡ {envâ€¿part ğ•Š data :
  util â† â€¢Import "/util.bqn"âˆ¾Ëœ"." env.VarâŒ¾â‹ˆ "BQN_LIB"
  "region" util.Debug xmaxâ€¿ymax â† â‹ˆâ—‹(2âŠ¸+)Â´âŒˆË>âˆ¾segments â† <Ë˜Â¨âˆ˜â€¿2âŠ¸â¥ŠÂ¨âŸ¨âŸ©âŠ¸â‰¢Â¨âŠ¸/util.ParseIntsÂ¨data
  {2=part ? xmax ymaxâŠ¸+ â†© ; @}
  map â† ymaxâ€¿xmaxâ¥Š0Ë™â†•xmaxÃ—ymax
  InjectBlocks â† {begâ€¿end :
    dxâ€¿dy â† end-beg
    seq â† {
      0<dy ? â‹ˆâŸœ(0âŠ‘beg)Â¨(1âŠ‘beg)+â†•1+|dy ;
      0>dy ? â‹ˆâŸœ(0âŠ‘end)Â¨(1âŠ‘end)+â†•1+|dy ;
      0<dx ? (1âŠ‘beg)âŠ¸â‹ˆÂ¨(0âŠ‘beg)+â†•1+|dx ;
      0>dx ? (1âŠ‘end)âŠ¸â‹ˆÂ¨(0âŠ‘end)+â†•1+|dx
    }
    map 1Â¨âŒ¾(seqâŠ¸âŠ‘) â†©
  }Â¨<Ë˜âˆ˜(2âŠ¸â†•)
  InjectBlocksÂ¨segments
  {
    1=part ?
      DropSand â† {
        1âŠ‘{fallingâ€¿tr :
          loc â† Â¯1âŠ‘tr
          {
            ymax=1+âŠ‘loc                ? map 1Ë™âŒ¾(locâŠ¸âŠ‘) â†© â‹„ 0â€¿âŸ¨âŸ© ;
            (newloc â† loc+1â€¿ 0)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
            (newloc â† loc+1â€¿Â¯1)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
            (newloc â† loc+1â€¿ 1)(Â¬âŠ‘)map ? 1â‹ˆtrâˆ¾âŸ¨newlocâŸ© ;
                                         map 1Ë™âŒ¾(locâŠ¸âŠ‘) â†© â‹„ âŸ¨0,Â¯1â†“trâŸ©
          }
        }â€¢_while_âŠ‘1â€¿ğ•©
      }
      Â¯1+âŠ‘{sandsâ€¿trace : âŸ¨1+sands,DropSand traceâŸ©}â€¢_while_{âŸ¨âŸ©âŠ¸â‰¢1âŠ‘ğ•©}0â€¿âŸ¨0â€¿500âŸ©
    ;
      floor â† 2+âŒˆÂ´1âŠ¸âŠ‘Â¨âˆ¾segments
      map â†© (1+floor)â€¿(2Ã—xmax)â†‘map       # Expand region
      map â†© 1Â¨âŒ¾(Â¯1âŠ¸âŠ)map            # Fill the bottom line as sentinel
      BottomIndices â† {yâ€¿x ğ•Š down: (y+down)âˆ¾Â¨down-Ëœx+â†•1+2Ã—down} # â‹„ ! 8â€¿Â¯1â‰¡âŠ‘5â€¿2 BottomIndices 3
      # "map" util.Debug â‰¢map
      # "indices" util.Debug 0â€¿500 BottomIndices 5
      FlatBottom â† âˆ§Â´0=(âŠ‘âŸœmap)Â¨    # â‹„ ! 0â€¿500 FlatBottomâˆ˜BottomIndices 5
      {S to_visit :
        âŸ¨startâŸ©â€¿remain â† 1(â†‘â‹ˆâ†“)to_visit
        {ğ•Š ğ•©:
          floorâ‰¤ğ•©+âŠ‘start ? remain ;
          l â† start BottomIndices down â† ğ•©
          {FlatBottom l ? map 2Â¨âŒ¾(lâŠ¸âŠ‘) â†© â‹„ 1+down ; 0<down ? remainâˆ¾Ëœ(0=âŠ‘âŸœmap)Â¨âŠ¸/Â¯1âŒ½l ; remain}
        }â€¢_while_(1=â€¢Type)0
      }â€¢_while_(âŸ¨âŸ©âŠ¸â‰¢)âŸ¨0â€¿500âŸ©
      # "map" util.Debug ".#â—‹"âŠ¸(âŠ‘Ëœ)Â¨(40âŠ¸â†‘480âŠ¸â†“)Ë˜map
      +Â´2=â¥Šmap
  }
}

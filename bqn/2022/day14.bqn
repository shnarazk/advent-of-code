lib â† â€¢Import "../lib.bqn"

Solve â‡ { part ğ•Š data:
  "region" lib.Debug xmaxâ€¿ymax â† â‹ˆâ—‹(2âŠ¸+)Â´âŒˆË>âˆ¾segments â† <Ë˜Â¨âˆ˜â€¿2âŠ¸â¥ŠÂ¨âŸ¨âŸ©âŠ¸â‰¢Â¨âŠ¸/lib.ParseIntsÂ¨data
  {
    1=part ?
      map â† ymaxâ€¿xmaxâ¥Š 0Ë™â†•xmaxÃ—ymax
      InjectBlocks â† {ğ•Š begâ€¿end :
        dxâ€¿dy â† end-beg
        seq â† {
          0<dy ? â‹ˆâŸœ(0âŠ‘beg)Â¨(1âŠ‘beg)+â†•1+|dy ;
          0>dy ? â‹ˆâŸœ(0âŠ‘end)Â¨(1âŠ‘end)+â†•1+|dy ;
          0<dx ? (1âŠ‘beg)âŠ¸â‹ˆÂ¨(0âŠ‘beg)+â†•1+|dx ;
          0>dx ? (1âŠ‘end)âŠ¸â‹ˆÂ¨(0âŠ‘end)+â†•1+|dx
        }
        map (1Ë™Â¨seq)âŒ¾(seqâŠ¸âŠ‘) â†©
        âŸ¨âŸ©
      }Â¨<Ë˜âˆ˜(2âŠ¸â†•)
      InjectBlocksÂ¨segments
      DropSand1 â† {ğ•Š tr :
        1âŠ‘{ğ•Š fallingâ€¿tr :
          loc â† Â¯1âŠ‘tr
          {
            ymax=1+âŠ‘loc                  ? map 1Ë™âŒ¾(locâŠ¸âŠ‘) â†© â‹„ 0â€¿âŸ¨âŸ© ;
            ((loc+offset â† 1â€¿ 0)(Â¬âŠ‘)map) ? 1â‹ˆtrâˆ¾âŸ¨loc+offsetâŸ© ;
            ((loc+offset â† 1â€¿Â¯1)(Â¬âŠ‘)map) ? 1â‹ˆtrâˆ¾âŸ¨loc+offsetâŸ© ;
            ((loc+offset â† 1â€¿ 1)(Â¬âŠ‘)map) ? 1â‹ˆtrâˆ¾âŸ¨loc+offsetâŸ© ;
                                           map 1Ë™âŒ¾(locâŠ¸âŠ‘) â†© â‹„ âŸ¨0,Â¯1â†“trâŸ©
          }
        }â€¢_while_âŠ‘1â€¿tr
      }
      Â¯1+âŠ‘{ğ•Š sandsâ€¿trace : âŸ¨1+sands,DropSand1 traceâŸ©}â€¢_while_{âŸ¨âŸ©âŠ¸â‰¢1âŠ‘ğ•©}0â€¿âŸ¨0â€¿500âŸ©
    ;
      xmax ymaxâŠ¸+ â†©
      map â† ymaxâ€¿xmaxâ¥Š 0Ë™â†•xmaxÃ—ymax
      InjectBlocks â† { ğ•Š begâ€¿end:
        dxâ€¿dy â† end-beg
        seq â† {
          0<dy ? â‹ˆâŸœ(0âŠ‘beg)Â¨(1âŠ‘beg)+â†•1+|dy ;
          0>dy ? â‹ˆâŸœ(0âŠ‘end)Â¨(1âŠ‘end)+â†•1+|dy ;
          0<dx ? (1âŠ‘beg)âŠ¸â‹ˆÂ¨(0âŠ‘beg)+â†•1+|dx ;
          0>dx ? (1âŠ‘end)âŠ¸â‹ˆÂ¨(0âŠ‘end)+â†•1+|dx
        }
        map (1Ë™Â¨seq)âŒ¾(seqâŠ¸âŠ‘) â†©
        âŸ¨âŸ©
      }Â¨<Ë˜âˆ˜(2âŠ¸â†•)
      InjectBlocksÂ¨segments
      0{y Drop x : 0=yâ€¿xâŠ‘map ? map 2Ë™âŒ¾(yâ€¿xâŠ¸âŠ‘) â†© â‹„ {ymax>yy â† 1+y ? yy DropÂ¨ x+âŸ¨Â¯1,0,1âŸ© ; @} ; @}500
      +Â´2=â¥Šmap
  }
}
